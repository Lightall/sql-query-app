<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL æŸ¥è¯¢å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .sidebar h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .table-info {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .table-info h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .table-info .columns {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .table-info .row-count {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .query-section {
            margin-bottom: 30px;
        }

        .query-section label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
            font-size: 16px;
        }

        .sql-input {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .sql-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #28a745;
            color: white;
        }

        .btn-secondary:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .examples {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .examples h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .example-query {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid #667eea;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #333;
        }

        .example-query:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .result-section {
            margin-top: 30px;
        }

        .result-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .result-info {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            color: #004085;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
            color: #333;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #f5c6cb;
            margin-top: 20px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” SQL æŸ¥è¯¢å·¥å…·</h1>
            <p>åœ¨çº¿æ‰§è¡Œ SQL æŸ¥è¯¢å¹¶å¯¼å‡ºç»“æœ</p>
        </div>

        <div class="content">
            <div class="sidebar" id="sidebar">
                <h3>ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„</h3>
                <div id="tables-list">åŠ è½½ä¸­...</div>
            </div>

            <div class="query-section">
                <label for="sqlInput">SQL æŸ¥è¯¢è¯­å¥</label>
                <textarea
                    id="sqlInput"
                    class="sql-input"
                    placeholder="è¾“å…¥ SQL æŸ¥è¯¢è¯­å¥ï¼Œä¾‹å¦‚ï¼šSELECT * FROM users;"
                ></textarea>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="executeQuery()">
                        â–¶ï¸ æ‰§è¡ŒæŸ¥è¯¢
                    </button>
                    <button class="btn btn-secondary" id="downloadBtn" onclick="downloadResults()" disabled>
                        â¬‡ï¸ ä¸‹è½½ç»“æœ (CSV)
                    </button>
                </div>

                <div class="examples">
                    <h3>ğŸ’¡ ç¤ºä¾‹æŸ¥è¯¢</h3>
                    <div class="example-query" onclick="setQuery('SELECT * FROM users;')">
                        SELECT * FROM users;
                    </div>
                    <div class="example-query" onclick="setQuery('SELECT * FROM orders WHERE status = \'completed\';')">
                        SELECT * FROM orders WHERE status = 'completed';
                    </div>
                    <div class="example-query" onclick="setQuery('SELECT u.name, u.city, o.product, o.amount FROM users u JOIN orders o ON u.id = o.user_id ORDER BY o.amount DESC;')">
                        SELECT u.name, u.city, o.product, o.amount FROM users u JOIN orders o ON u.id = o.user_id ORDER BY o.amount DESC;
                    </div>
                    <div class="example-query" onclick="setQuery('SELECT city, COUNT(*) as user_count, AVG(age) as avg_age FROM users GROUP BY city;')">
                        SELECT city, COUNT(*) as user_count, AVG(age) as avg_age FROM users GROUP BY city;
                    </div>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨æ‰§è¡ŒæŸ¥è¯¢...</p>
            </div>

            <div id="errorMessage"></div>

            <div class="result-section" id="resultSection" style="display: none;">
                <h2>æŸ¥è¯¢ç»“æœ</h2>
                <div class="result-info">
                    <span id="resultCount"></span>
                </div>
                <div class="table-container">
                    <table id="resultTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="empty-state" id="emptyState">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3>è¾“å…¥ SQL æŸ¥è¯¢è¯­å¥å¹¶æ‰§è¡Œ</h3>
                <p>ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
            </div>
        </div>
    </div>

    <script>
        let currentResults = null;

        // é¡µé¢åŠ è½½æ—¶è·å–è¡¨ä¿¡æ¯
        window.addEventListener('DOMContentLoaded', function() {
            loadTables();
        });

        // åŠ è½½æ•°æ®åº“è¡¨ä¿¡æ¯
        async function loadTables() {
            try {
                const response = await fetch('/tables');
                const data = await response.json();

                const tablesList = document.getElementById('tables-list');
                if (data.tables && data.tables.length > 0) {
                    tablesList.innerHTML = data.tables.map(table => `
                        <div class="table-info">
                            <h4>${table.name}</h4>
                            <div class="columns">
                                ${table.columns.map(col => `<span>${col.name} (${col.type})</span>`).join(', ')}
                            </div>
                            <div class="row-count">å…± ${table.row_count} æ¡è®°å½•</div>
                        </div>
                    `).join('');
                } else {
                    tablesList.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°è¡¨</p>';
                }
            } catch (error) {
                console.error('åŠ è½½è¡¨ä¿¡æ¯å¤±è´¥:', error);
                document.getElementById('tables-list').innerHTML = '<p>åŠ è½½å¤±è´¥</p>';
            }
        }

        // è®¾ç½®æŸ¥è¯¢è¯­å¥
        function setQuery(query) {
            document.getElementById('sqlInput').value = query;
        }

        // æ‰§è¡ŒæŸ¥è¯¢
        async function executeQuery() {
            const sqlInput = document.getElementById('sqlInput').value.trim();

            if (!sqlInput) {
                showError('è¯·è¾“å…¥ SQL æŸ¥è¯¢è¯­å¥');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').classList.add('active');
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('errorMessage').innerHTML = '';
            document.getElementById('downloadBtn').disabled = true;

            try {
                const response = await fetch('/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sql: sqlInput })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'æŸ¥è¯¢å¤±è´¥');
                }

                // ä¿å­˜ç»“æœä¾›ä¸‹è½½ä½¿ç”¨
                currentResults = data;

                // æ˜¾ç¤ºç»“æœ
                displayResults(data);

            } catch (error) {
                showError(error.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
        function displayResults(data) {
            const { columns, data: rows, count } = data;

            // æ›´æ–°ç»“æœè®¡æ•°
            document.getElementById('resultCount').textContent = `å…±æŸ¥è¯¢åˆ° ${count} æ¡è®°å½•`;

            // æ„å»ºè¡¨å¤´
            const tableHead = document.getElementById('tableHead');
            tableHead.innerHTML = '<tr>' + columns.map(col => `<th>${col}</th>`).join('') + '</tr>';

            // æ„å»ºè¡¨ä½“
            const tableBody = document.getElementById('tableBody');
            if (rows.length > 0) {
                tableBody.innerHTML = rows.map(row =>
                    '<tr>' + row.map(cell => `<td>${cell !== null ? cell : 'NULL'}</td>`).join('') + '</tr>'
                ).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="' + columns.length + '" style="text-align: center; padding: 30px; color: #999;">æ²¡æœ‰æŸ¥è¯¢åˆ°æ•°æ®</td></tr>';
            }

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('emptyState').style.display = 'none';
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div class="error"><strong>é”™è¯¯ï¼š</strong>${message}</div>`;
            document.getElementById('emptyState').style.display = 'block';
        }

        // ä¸‹è½½ç»“æœä¸º CSV
        async function downloadResults() {
            if (!currentResults) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„ç»“æœ');
                return;
            }

            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        columns: currentResults.columns,
                        data: currentResults.data
                    })
                });

                if (!response.ok) {
                    throw new Error('ä¸‹è½½å¤±è´¥');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `query_result_${new Date().getTime()}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        // æ”¯æŒ Ctrl+Enter æ‰§è¡ŒæŸ¥è¯¢
        document.getElementById('sqlInput').addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                executeQuery();
            }
        });
    </script>
</body>
</html>
